<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stickman Parkour</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #222; overflow: hidden; touch-action: none; }
        #game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: linear-gradient(to bottom, #87CEEB, #E0F7FA); }
        canvas { background: transparent; max-width: 100%; max-height: 100%; }
        #ui-layer { position: absolute; top: 20px; left: 20px; color: #333; font-family: monospace; font-weight: bold; font-size: 20px; pointer-events: none; z-index: 20; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 30; }
        .hidden { display: none !important; }
        h1 { color: #fff; font-family: monospace; font-size: 32px; margin-bottom: 20px; text-align: center; }
        p { color: #ccc; font-family: monospace; font-size: 16px; margin-bottom: 30px; text-align: center; padding: 0 20px; }
        button { padding: 15px 30px; font-size: 20px; font-family: monospace; font-weight: bold; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer; }
        #controls { position: absolute; bottom: 30px; left: 0; width: 100%; height: 100px; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 25; pointer-events: auto; }
        .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.3); border: 2px solid rgba(255,255,255,0.8); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; color: white; user-select: none; }
        .jump-btn { background: rgba(255,71,87,0.5); border-color: #ff4757; }
        .btn:active { background: rgba(255,255,255,0.6); }
    </style>
</head>
<body>
<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">LIVES: <span id="lives">❤️❤️❤️❤️❤️</span> | LVL: <span id="lvl">1</span></div>
    
    <div id="start-screen" class="screen">
        <h1>Stick Parkour</h1>
        <p>Avoid spikes. Reach the green zone.</p>
        <button id="start-btn">START GAME</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 id="go-title">GAME OVER</h1>
        <button id="restart-btn">TRY AGAIN</button>
    </div>

    <div id="controls">
        <div style="display:flex; gap:20px">
            <div class="btn" id="btn-left">←</div>
            <div class="btn" id="btn-right">→</div>
        </div>
        <div class="btn jump-btn" id="btn-jump">↑</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let audioCtx = null; // Init later to prevent crash

function resize(){ canvas.width=800; canvas.height=400; }
window.addEventListener('resize', resize); resize();

const GRAVITY=0.6, SPEED=5, JUMP=-12;
let state={run:false,lives:5,lvl:0,cam:0}, keys={l:false,r:false,u:false};
const player={x:50,y:200,w:20,h:50,vx:0,vy:0,ground:false,frame:0};

// LEVELS
const levels=[
    [{x:0,y:350,w:800,h:50,t:1},{x:300,y:280,w:100,h:20,t:1},{x:500,y:220,w:100,h:20,t:1},{x:750,y:280,w:50,h:250,t:3}],
    [{x:0,y:350,w:200,h:50,t:1},{x:250,y:350,w:550,h:50,t:1},{x:220,y:390,w:30,h:30,t:2},{x:500,y:250,w:100,h:20,t:1},{x:700,y:200,w:100,h:20,t:1},{x:750,y:150,w:40,h:50,t:3}],
    [{x:0,y:350,w:150,h:50,t:1},{x:200,y:300,w:80,h:20,t:1},{x:0,y:390,w:800,h:20,t:2},{x:400,y:150,w:300,h:20,t:1},{x:750,y:100,w:40,h:50,t:3}],
    [{x:0,y:300,w:100,h:50,t:1},{x:150,y:300,w:30,h:200,t:1},{x:250,y:300,w:30,h:200,t:1},{x:350,y:300,w:30,h:200,t:1},{x:450,y:250,w:100,h:20,t:1},{x:480,y:230,w:40,h:20,t:2},{x:650,y:250,w:100,h:20,t:3}],
    [{x:0,y:300,w:100,h:50,t:1},{x:150,y:380,w:500,h:20,t:2},{x:150,y:300,w:50,h:10,t:1},{x:350,y:200,w:50,h:10,t:1},{x:500,y:200,w:200,h:20,t:1},{x:750,y:150,w:50,h:50,t:3}]
];

// SAFE AUDIO SYSTEM
function initAudio() {
    if(!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

function playTone(t){
    if(!audioCtx) return; // Prevent crash if audio failed
    try {
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const time=audioCtx.currentTime;
        if(t=='j'){o.frequency.setValueAtTime(150,time);o.frequency.linearRampToValueAtTime(300,time+0.1);g.gain.setValueAtTime(0.1,time);o.stop(time+0.1);}
        if(t=='d'){o.type='sawtooth';o.frequency.setValueAtTime(200,time);o.frequency.linearRampToValueAtTime(50,time+0.3);g.gain.setValueAtTime(0.2,time);o.stop(time+0.3);}
        if(t=='w'){o.type='square';o.frequency.setValueAtTime(400,time);o.frequency.setValueAtTime(600,time+0.1);g.gain.setValueAtTime(0.1,time);o.stop(time+0.2);}
        o.start(time);
    } catch(e) { console.log('Audio Blocked'); }
}

// CONTROLS
window.onkeydown=e=>{if(e.code=='ArrowRight')keys.r=true;if(e.code=='ArrowLeft')keys.l=true;if(e.code=='ArrowUp'||e.code=='Space'){keys.u=true;if(!state.run)return;if(player.ground){player.vy=JUMP;player.ground=false;playTone('j');}}};
window.onkeyup=e=>{if(e.code=='ArrowRight')keys.r=false;if(e.code=='ArrowLeft')keys.l=false;if(e.code=='ArrowUp'||e.code=='Space')keys.u=false;};
const bind=(id,k)=>{const b=document.getElementById(id);b.ontouchstart=b.onmousedown=e=>{e.preventDefault();keys[k]=true;if(k=='u'&&player.ground){player.vy=JUMP;player.ground=false;playTone('j');}b.style.transform="scale(0.9)";};b.ontouchend=b.onmouseup=b.onmouseleave=e=>{e.preventDefault();keys[k]=false;b.style.transform="scale(1)";};};
bind('btn-left','l');bind('btn-right','r');bind('btn-jump','u');

// BUTTON LISTENERS (Safe Init)
document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('start-btn').addEventListener('touchstart', startGame);
document.getElementById('restart-btn').addEventListener('click', startGame);
document.getElementById('restart-btn').addEventListener('touchstart', startGame);

function startGame(e){
    if(e) e.preventDefault(); // Stop double fire
    initAudio(); // Wake up audio on click
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-over-screen').classList.add('hidden');
    state.run=true;state.lives=5;state.lvl=0;resetPlayer();
    requestAnimationFrame(loop);
}

function resetPlayer(){player.x=50;player.y=200;player.vx=0;player.vy=0;player.ground=false;updateUI();}
function updateUI(){document.getElementById('lives').innerText="❤️".repeat(state.lives);document.getElementById('lvl').innerText=state.lvl+1;}

function loop(){
    if(!state.run) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Physics
    if(keys.r)player.vx+=1;if(keys.l)player.vx-=1;player.vx*=0.8;player.vy+=GRAVITY;
    if(player.vx>SPEED)player.vx=SPEED;if(player.vx<-SPEED)player.vx=-SPEED;
    player.x+=player.vx;player.y+=player.vy;player.ground=false;
    
    // Death Pit
    if(player.y>600) { die(); return; } // Return prevents loops

    // Camera
    state.cam+=(player.x-200-state.cam)*0.1;
    ctx.save();ctx.translate(-state.cam,0);

    // Level & Collision
    const map=levels[state.lvl];
    if(map){
        for(let i=0; i<map.length; i++) { // Using FOR loop for safe break
            let o = map[i];
            ctx.fillStyle=o.t==1?'#444':(o.t==2?'#e74c3c':'#2ecc71');
            ctx.fillRect(o.x,o.y,o.w,o.h);
            
            // Collision Check
            if(player.x < o.x+o.w && player.x+player.w > o.x && player.y < o.y+o.h && player.y+player.h > o.y){
                if(o.t==2) {
                    die(); 
                    ctx.restore(); return; // STOP FRAME
                } 
                else if(o.t==3) { 
                    playTone('w'); 
                    state.lvl++; 
                    if(state.lvl>=levels.length) endGame(true); 
                    else resetPlayer(); 
                    ctx.restore(); return; // CRITICAL: Stop frame so we don't collide with new level items instantly
                }
                else {
                    // Solid Ground Logic
                    let ox=(player.x+player.w/2)-(o.x+o.w/2),oy=(player.y+player.h/2)-(o.y+o.h/2);
                    if(Math.abs(ox/o.w)<Math.abs(oy/o.h)){
                        if(oy>0){player.y=o.y+o.h;player.vy=0;}
                        else{player.y=o.y-player.h;player.vy=0;player.ground=true;}
                    } else {
                        if(ox>0){player.x=o.x+o.w;player.vx=0;}
                        else{player.x=o.x-player.w;player.vx=0;}
                    }
                }
            }
        }
    }

    // Draw Player
    ctx.strokeStyle='#333';ctx.lineWidth=3;ctx.lineCap='round';ctx.translate(player.x+player.w/2,player.y+player.h/2);
    if(player.vx<-0.1)ctx.scale(-1,1);player.frame+=Math.abs(player.vx)*0.5;const l=Math.sin(player.frame)*8;
    ctx.beginPath();ctx.arc(0,-15,6,0,7);ctx.moveTo(0,-9);ctx.lineTo(0,5);
    if(player.ground){ctx.moveTo(0,5);ctx.lineTo(-5+l,18);ctx.moveTo(0,5);ctx.lineTo(5-l,18);}
    else{ctx.moveTo(0,5);ctx.lineTo(-6,15);ctx.moveTo(0,5);ctx.lineTo(8,12);}
    ctx.moveTo(0,-5);ctx.lineTo(-6-Math.cos(player.frame)*8,5);ctx.moveTo(0,-5);ctx.lineTo(6+Math.cos(player.frame)*8,5);
    ctx.stroke();ctx.restore();
    
    requestAnimationFrame(loop);
}

function die(){playTone('d');state.lives--;updateUI();if(state.lives<=0)endGame(false);else resetPlayer();}
function endGame(win){state.run=false;document.getElementById('game-over-screen').classList.remove('hidden');document.getElementById('go-title').innerText=win?"YOU WON!":"GAME OVER";}
</script>
</body>
</html>
